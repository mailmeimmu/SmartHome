<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Home Admin Console</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f172a;
      --panel: rgba(15, 23, 42, 0.9);
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --text: #f9fafb;
      --muted: #94a3b8;
      --danger: #f87171;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 40px 16px;
    }
    .card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      width: min(960px, 100%);
      padding: 32px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.45);
    }
    h1 {
      margin-top: 0;
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    input, select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.75);
      color: var(--text);
      font-size: 16px;
    }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    button {
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(59, 130, 246, 0.35); }
    button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
    .muted { color: var(--muted); }
    .hidden { display: none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      text-align: left;
    }
    th { color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 12px; }
    td.actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }
    .danger { background: rgba(248, 113, 113, 0.15); color: var(--danger); border-color: rgba(248, 113, 113, 0.35); }
    .danger:hover { box-shadow: 0 10px 24px rgba(248, 113, 113, 0.35); }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin: 24px 0 16px;
    }
    a { color: var(--accent); }
    @media (max-width: 600px) {
      .card { padding: 24px; }
      h1 { font-size: 24px; }
      table { font-size: 14px; }
      th, td { padding: 10px 8px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div id="login-view">
      <h1>Smart Home Super Admin</h1>
      <p class="muted">Enter the super admin credentials configured on the server to manage owners and members.</p>
      <div style="margin-top: 24px; display: grid; gap: 16px;">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="admin@example.com" autocomplete="email" />
        </div>
        <div>
          <label for="pin">PIN</label>
          <input id="pin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
        </div>
        <button id="login-btn">Sign In</button>
      </div>
    </div>

    <div id="console-view" class="hidden">
      <div class="toolbar">
        <div>
          <h1 style="margin: 0;">User Management</h1>
          <p class="muted" id="session-info"></p>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="refresh-btn" style="background:transparent; border-color: rgba(148,163,184,0.4); color: var(--text);">Refresh</button>
          <button id="logout-btn" class="danger">Sign Out</button>
        </div>
      </div>

      <section style="margin-top: 24px;">
        <h2 style="margin: 0 0 12px; font-size: 18px;">Register Owner / User</h2>
        <p class="muted" style="margin-bottom: 16px;">Create household owners here. Owners can then register their family members from the mobile app.</p>
        <div class="grid">
          <div>
            <label for="new-name">Full Name</label>
            <input id="new-name" type="text" placeholder="Owner name" />
          </div>
          <div>
            <label for="new-email">Email</label>
            <input id="new-email" type="email" placeholder="owner@example.com" />
          </div>
          <div>
            <label for="new-pin">PIN</label>
            <input id="new-pin" type="password" inputmode="numeric" maxlength="6" placeholder="Temporary PIN" />
          </div>
          <div>
            <label for="new-role">Role</label>
            <select id="new-role">
              <option value="parent">Owner (Parent)</option>
              <option value="member">Member</option>
              <option value="admin">Super Admin</option>
            </select>
          </div>
        </div>
        <button id="create-btn" style="margin-top: 16px;">Create User</button>
      </section>

      <section style="margin-top: 32px;">
        <div style="display:flex; justify-content: space-between; align-items:center;">
          <h2 style="margin: 0; font-size: 18px;">All Users</h2>
          <span id="user-count" class="muted"></span>
        </div>
        <div id="users-table-wrapper"></div>
      </section>
    </div>
  </div>

  <script>
    const API_BASE = '';
    const loginView = document.getElementById('login-view');
    const consoleView = document.getElementById('console-view');
    const loginBtn = document.getElementById('login-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const createBtn = document.getElementById('create-btn');
    const sessionInfo = document.getElementById('session-info');
    const userCount = document.getElementById('user-count');
    const usersTableWrapper = document.getElementById('users-table-wrapper');

    const emailInput = document.getElementById('email');
    const pinInput = document.getElementById('pin');

    const newName = document.getElementById('new-name');
    const newEmail = document.getElementById('new-email');
    const newPin = document.getElementById('new-pin');
    const newRole = document.getElementById('new-role');

    let adminToken = localStorage.getItem('adminToken') || '';
    let adminUser = JSON.parse(localStorage.getItem('adminUser') || 'null');

    function authHeaders(headers = {}) {
      if (adminToken) headers['Authorization'] = 'Bearer ' + adminToken;
      return headers;
    }

    async function api(path, options = {}) {
      const opts = { ...options };
      opts.headers = authHeaders(opts.headers || {});
      if (opts.body && typeof opts.body !== 'string') {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(opts.body);
      }
      const res = await fetch(API_BASE + path, opts);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const err = new Error(data?.error || 'Request failed');
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function showLogin() {
      loginView.classList.remove('hidden');
      consoleView.classList.add('hidden');
    }

    function showConsole() {
      loginView.classList.add('hidden');
      consoleView.classList.remove('hidden');
      sessionInfo.textContent = adminUser ? `${adminUser.name} • ${adminUser.email}` : '';
      loadUsers();
    }

    async function handleLogin() {
      const email = emailInput.value.trim();
      const pin = pinInput.value.trim();
      if (!email || !pin) {
        alert('Please enter email and PIN.');
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in…';
      try {
        const res = await fetch(API_BASE + '/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, pin })
        });
        const data = await res.json();
        if (!res.ok || !data?.success) {
          throw new Error(data?.error || 'Login failed');
        }
        adminToken = data.token;
        adminUser = data.user;
        localStorage.setItem('adminToken', adminToken);
        localStorage.setItem('adminUser', JSON.stringify(adminUser));
        emailInput.value = '';
        pinInput.value = '';
        showConsole();
      } catch (err) {
        alert(err.message || 'Login failed');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    }

    async function loadUsers() {
      if (!adminToken) return;
      try {
        usersTableWrapper.innerHTML = '<p class="muted">Loading users…</p>';
        const { users } = await api('/api/admin/users');
        userCount.textContent = `${users.length} users`;
        renderUsers(users);
      } catch (err) {
        usersTableWrapper.innerHTML = `<p style="color: var(--danger)">${err.message || 'Failed to load users.'}</p>`;
        if (err.status === 401) {
          logout();
        }
      }
    }

    function renderUsers(users) {
      if (!users?.length) {
        usersTableWrapper.innerHTML = '<p class="muted">No users yet. Create an owner above.</p>';
        return;
      }
      const rows = users.map((user) => {
        const badge = user.role === 'admin' ? 'Super Admin' : user.role === 'parent' ? 'Owner' : 'Member';
        return `
          <tr>
            <td>
              <div><strong>${user.name || 'Unnamed'}</strong></div>
              <div class="muted">${user.email || 'No email'}</div>
            </td>
            <td>${user.relation || ''}</td>
            <td><span class="badge">${badge}</span></td>
            <td>
              <select data-action="role" data-id="${user.id}" value="${user.role}">
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Super Admin</option>
                <option value="parent" ${user.role === 'parent' ? 'selected' : ''}>Owner</option>
                <option value="member" ${user.role === 'member' ? 'selected' : ''}>Member</option>
              </select>
            </td>
            <td class="actions">
              <button data-action="delete" data-id="${user.id}" class="danger" style="border-color: rgba(248,113,113,0.3);">Remove</button>
            </td>
          </tr>
        `;
      }).join('');
      usersTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Relation</th>
              <th>Role</th>
              <th>Change Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      usersTableWrapper.querySelectorAll('select[data-action="role"]').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const id = sel.getAttribute('data-id');
          const role = sel.value;
          if (!confirm(`Change role to ${role}?`)) { sel.value = sel.getAttribute('value'); return; }
          updateRole(id, role);
        });
      });
      usersTableWrapper.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (adminUser && String(adminUser.id) === String(id)) {
            alert('You cannot delete the signed-in admin account.');
            return;
          }
          if (confirm('Delete this user?')) deleteUser(id);
        });
      });
    }

    async function updateRole(id, role) {
      try {
        await api(`/api/admin/users/${id}`, { method: 'PATCH', body: { role } });
        loadUsers();
      } catch (err) {
        alert(err.message || 'Failed to update role');
      }
    }

    async function deleteUser(id) {
      try {
        await api(`/api/admin/users/${id}`, { method: 'DELETE' });
        loadUsers();
      } catch (err) {
        alert(err.message || 'Failed to delete user');
      }
    }

    async function createUser() {
      const name = newName.value.trim();
      const email = newEmail.value.trim();
      const pin = newPin.value.trim();
      const role = newRole.value;
      if (!name) {
        alert('Please add a name.');
        return;
      }
      if (!pin) {
        alert('PIN is required.');
        return;
      }
      createBtn.disabled = true;
      createBtn.textContent = 'Creating…';
      try {
        await api('/api/admin/users', {
          method: 'POST',
          body: { name, email, role, relation: role === 'parent' ? 'owner' : '', pin }
        });
        newName.value = '';
        newEmail.value = '';
        newPin.value = '';
        newRole.value = 'parent';
        loadUsers();
      } catch (err) {
        alert(err.message || 'Failed to create user');
      } finally {
        createBtn.disabled = false;
        createBtn.textContent = 'Create User';
      }
    }

    function logout() {
      adminToken = '';
      adminUser = null;
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUser');
      showLogin();
    }

    loginBtn.addEventListener('click', handleLogin);
    pinInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleLogin(); });
    refreshBtn.addEventListener('click', loadUsers);
    logoutBtn.addEventListener('click', logout);
    createBtn.addEventListener('click', createUser);

    if (adminToken) {
      showConsole();
    } else {
      showLogin();
    }
  </script>
</body>
</html>
